<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <div class="perfil-header">
        <button class="btn-regresar" (click)="regresar()">
          <ion-icon name="arrow-back-outline"></ion-icon>
        </button>

        <img src="/assets/icon/logo4.png" alt="Go Autos" class="logo" />
        <span *ngIf="auto" class="titulo-perfil">
          {{ auto.marca }} {{ auto.modelo }} {{ auto.anio }}
        </span>
      </div>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button (click)="regresar()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="titulo-editar">
    <h1>
      <ion-icon name="build-outline"></ion-icon>
      <span>Edita <span class="car-name">tu auto</span></span>
    </h1>
    <p>Actualiza la informaci√≥n, im√°genes y ubicaci√≥n de tu veh√≠culo</p>
  </div>

  <div class="contenedor">
    <div class="barra-secciones">
      <button [class.activa]="seccionActiva === 'datos'" (click)="seccionActiva = 'datos'">
        <ion-icon name="create-outline"></ion-icon>
        Datos del veh√≠culo
      </button>
      <button [class.activa]="seccionActiva === 'imagenes'" (click)="seccionActiva = 'imagenes'">
        <ion-icon name="images-outline"></ion-icon>
        Im√°genes
      </button>
    </div>

    <!-- üî∏ SECCI√ìN DATOS -->
    <div *ngIf="seccionActiva === 'datos'">
      <div class="layout-dos-columnas">
        <div class="columna-datos">
          <!-- üöó AUTOS -->
          <ion-grid *ngIf="(tipo_veiculo === 'autos' || tipo_veiculo === 'renta') && auto">
            <ion-row *ngIf="auto?.version?.length > 1">
              <ion-col size="12">
                <div class="section-title">
                  <ion-icon name="albums-outline"></ion-icon>
                  <span>Versiones</span>
                </div>
              </ion-col>
            </ion-row>

            <ion-row class="row-versiones" *ngIf="auto?.version?.length > 1">
              <ion-col *ngFor="let v of auto.version; let i = index" class="version-col" size="6" size-sm="6"
                size-md="4">
                <div class="contenedor-input-version">
                  <label class="titulo-version">{{ v.Name }}</label>
                  <ion-item lines="none">
                    <ion-label position="floating">Precio</ion-label>
                    <ion-input type="number" [(ngModel)]="auto.version[i].Precio"
                      (ionInput)="verificarCambiosPrecio()"></ion-input>
                    <ion-button *ngIf="auto.tipoVenta == 'nuevo'" fill="clear" color="danger"
                      (click)="eliminarVersion(i)" slot="end">
                      <ion-icon name="trash-outline"></ion-icon>
                    </ion-button>
                  </ion-item>
                </div>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="12" *ngIf="auto?.version?.length === 1">
                <div class="section-title">
                  <ion-icon name="albums-outline"></ion-icon>
                  <span>Versi√≥n: {{ auto.version[0]?.Name || '√önica' }}</span>
                </div>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="auto?.version?.length === 1">
                <ion-item>
                  <ion-label position="stacked">Precio</ion-label>
                  <ion-input type="number" [(ngModel)]="auto.version[0].Precio"
                    (ionInput)="verificarCambiosPrecio()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Kilometraje</ion-label>
                  <ion-input type="number" inputmode="numeric" pattern="\\d*" placeholder="Ej. 45000"
                    [(ngModel)]="auto.kilometraje" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Color</ion-label>
                  <ion-select placeholder="Selecciona un color" [(ngModel)]="auto.color" (ionChange)="markDirty()"
                    interface="alert" [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option *ngFor="let opcion of opciones" [value]="opcion.label">
                      {{ opcion.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Moneda</ion-label>
                  <ion-select [(ngModel)]="auto.moneda" (ionChange)="markDirty()" interface="alert"
                    [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option value="MXN">MXN - Pesos mexicanos</ion-select-option>
                    <ion-select-option value="USD">USD - D√≥lares estadounidenses</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Placas (opcional)</ion-label>
                  <ion-input placeholder="Ej. UVY-123-A" [(ngModel)]="auto.placas" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12">
                <ion-item lines="none">
                  <ion-label position="stacked">Descripci√≥n del veh√≠culo</ion-label>
                  <ion-textarea auto-grow="true" rows="4" placeholder="Ej. Auto en excelente estado, √∫nico due√±o..."
                    [(ngModel)]="auto.descripcion" (ionInput)="markDirty()"></ion-textarea>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- üèçÔ∏è MOTOS -->
          <ion-grid *ngIf="tipo_veiculo === 'motos' && auto">
            <ion-row class="row-versiones">
              <ion-col size="12" size-md="6">
                <div class="contenedor-input-version">
                  <label class="titulo-version">Precio</label>
                  <ion-item lines="none">
                    <ion-label position="floating">Precio</ion-label>
                    <ion-input type="number" [(ngModel)]="precioMoto" (ionInput)="verificarCambiosPrecio()"></ion-input>
                  </ion-item>
                </div>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Placas (opcional)</ion-label>
                  <ion-input placeholder="Ej. UVY-123-A" [(ngModel)]="auto.placas" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Kilometraje</ion-label>
                  <ion-input type="number" placeholder="Ej. 45000" [(ngModel)]="auto.kilometraje"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Color</ion-label>
                  <ion-select placeholder="Selecciona un color" [(ngModel)]="auto.color" (ionChange)="markDirty()"
                    interface="alert" [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option *ngFor="let opcion of opciones" [value]="opcion.label">
                      {{ opcion.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Moneda</ion-label>
                  <ion-select [(ngModel)]="auto.moneda" (ionChange)="markDirty()" interface="alert"
                    [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option value="MXN">MXN - Pesos mexicanos</ion-select-option>
                    <ion-select-option value="USD">USD - D√≥lares estadounidenses</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Tipo de Motor (opcional)</ion-label>
                  <ion-input placeholder="Ej. 4 tiempos, el√©ctrico..." [(ngModel)]="auto.tipoMotor"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Cilindrada</ion-label>
                  <ion-input placeholder="Ej. 150cc" [(ngModel)]="auto.cilindrada" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Transmisi√≥n</ion-label>
                  <ion-input placeholder="Ej. manual, CVT, etc." [(ngModel)]="auto.transmision"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Combustible (opcional)</ion-label>
                  <ion-input placeholder="Ej. gasolina, el√©ctrico..." [(ngModel)]="auto.combustible"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Frenos (opcional)</ion-label>
                  <ion-input placeholder="Ej. disco, tambor, ABS..." [(ngModel)]="auto.frenos"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Suspensi√≥n (opcional)</ion-label>
                  <ion-input placeholder="Ej. telesc√≥pica, mono-shock" [(ngModel)]="auto.suspension"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12">
                <ion-item lines="none">
                  <ion-label position="stacked">Descripci√≥n de la motocicleta</ion-label>
                  <ion-textarea auto-grow="true" rows="4" placeholder="Ej. Moto en excelente estado, √∫nico due√±o..."
                    [(ngModel)]="auto.descripcion" (ionInput)="markDirty()"></ion-textarea>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>

          <!-- üöö CAMIONES -->
          <ion-grid *ngIf="tipo_veiculo === 'camiones' && auto">
            <ion-row *ngIf="auto?.version?.length > 1">
              <ion-col size="12">
                <div class="section-title">
                  <ion-icon name="albums-outline"></ion-icon>
                  <span>Versiones</span>
                </div>
              </ion-col>
            </ion-row>

            <ion-row class="row-versiones" *ngIf="auto?.version?.length > 1">
              <ion-col *ngFor="let v of auto.version; let i = index" class="version-col" size="6" size-sm="6"
                size-md="4">
                <div class="contenedor-input-version">
                  <label class="titulo-version">{{ v.Name }}</label>
                  <ion-item lines="none">
                    <ion-label position="floating">Precio</ion-label>
                    <ion-input type="number" [(ngModel)]="auto.version[i].Precio"
                      (ionInput)="verificarCambiosPrecio()"></ion-input>
                    <ion-button *ngIf="auto.tipoVenta == 'nuevo'" fill="clear" color="danger"
                      (click)="eliminarVersion(i)" slot="end">
                      <ion-icon name="trash-outline"></ion-icon>
                    </ion-button>
                  </ion-item>
                </div>
              </ion-col>
            </ion-row>

            <ion-row>
              <ion-col size="12" *ngIf="auto?.version?.length === 1">
                <div class="section-title">
                  <ion-icon name="albums-outline"></ion-icon>
                  <span>Versi√≥n: {{ auto.version[0]?.Name || '√önica' }}</span>
                </div>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="auto?.version?.length === 1">
                <ion-item>
                  <ion-label position="stacked">Precio</ion-label>
                  <ion-input type="number" [(ngModel)]="auto.version[0].Precio"
                    (ionInput)="verificarCambiosPrecio()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!auto?.version?.length">
                <ion-item>
                  <ion-label position="stacked">Precio</ion-label>
                  <ion-input type="number" [(ngModel)]="auto.precio" (ionInput)="verificarCambiosPrecio()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Kilometraje</ion-label>
                  <ion-input type="number" inputmode="numeric" pattern="\\d*" placeholder="Ej. 120000"
                    [(ngModel)]="auto.kilometraje" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Color</ion-label>
                  <ion-select placeholder="Selecciona un color" [(ngModel)]="auto.color" (ionChange)="markDirty()"
                    interface="alert" [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option *ngFor="let opcion of opciones" [value]="opcion.label">
                      {{ opcion.label }}
                    </ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Moneda</ion-label>
                  <ion-select [(ngModel)]="auto.moneda" (ionChange)="markDirty()" interface="alert"
                    [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option value="MXN">MXN - Pesos mexicanos</ion-select-option>
                    <ion-select-option value="USD">USD - D√≥lares estadounidenses</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6" *ngIf="!isNuevo">
                <ion-item>
                  <ion-label position="stacked">Placas (opcional)</ion-label>
                  <ion-input placeholder="Ej. 12-AB-345" [(ngModel)]="auto.placas" (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Capacidad de carga (kg)</ion-label>
                  <ion-input type="number" placeholder="Ej. 8000" [(ngModel)]="auto.capacidadCarga"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Ejes</ion-label>
                  <ion-input type="number" placeholder="Ej. 2" [(ngModel)]="auto.ejes"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Tipo de cabina</ion-label>
                  <ion-select [(ngModel)]="auto.tipoCabina" placeholder="Selecciona" (ionChange)="markDirty()"
                    interface="alert" [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option value="Cabina sencilla">Cabina sencilla</ion-select-option>
                    <ion-select-option value="Doble cabina">Doble cabina</ion-select-option>
                    <ion-select-option value="Cabover">Cabover</ion-select-option>
                    <ion-select-option value="Dormitorio">Dormitorio</ion-select-option>
                    <ion-select-option value="Chasis">Chasis</ion-select-option>
                    <ion-select-option value="Otro">Otro</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Transmisi√≥n</ion-label>
                  <ion-input placeholder="Ej. manual, autom√°tica" [(ngModel)]="auto.transmision"
                    (ionInput)="markDirty()"></ion-input>
                </ion-item>
              </ion-col>

              <ion-col size="12" size-md="6">
                <ion-item>
                  <ion-label position="stacked">Combustible</ion-label>
                  <ion-select [(ngModel)]="auto.combustible" placeholder="Selecciona" (ionChange)="markDirty()"
                    interface="alert" [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                    <ion-select-option value="Di√©sel">Di√©sel</ion-select-option>
                    <ion-select-option value="Gasolina">Gasolina</ion-select-option>
                    <ion-select-option value="Gas Natural">Gas Natural</ion-select-option>
                    <ion-select-option value="El√©ctrico">El√©ctrico</ion-select-option>
                    <ion-select-option value="H√≠brido">H√≠brido</ion-select-option>
                    <ion-select-option value="Otro">Otro</ion-select-option>
                  </ion-select>
                </ion-item>
              </ion-col>

              <ion-col size="12">
                <ion-item lines="none">
                  <ion-label position="stacked">Descripci√≥n del cami√≥n</ion-label>
                  <ion-textarea auto-grow="true" rows="4" placeholder="Ej. Tracto en excelente estado, √∫nico due√±o..."
                    [(ngModel)]="auto.descripcion" (ionInput)="markDirty()"></ion-textarea>
                </ion-item>
              </ion-col>
            </ion-row>
          </ion-grid>
        </div>

        <!-- üìç Columna derecha (ubicaci√≥n y tipo) -->
        <div class="columna-ubicacion">
          <div class="contenedor_ubicaciones">
            <h2 class="titulo-ubicacion"><strong>Ubicaci√≥n</strong></h2>

            <div class="opciones-vehiculo">
              <div class="casilla" [class.activa]="tipoSeleccionado === 'particular'"
                (click)="seleccionarTipo('particular')">
                <img src="assets/img/particular.png" alt="Particular" />
                <p>Particular</p>
                <ion-icon name="checkmark-circle-outline" class="icono-check"></ion-icon>
              </div>

              <div class="casilla" [class.activa]="tipoSeleccionado === 'lote'"
                *ngIf="auto && (auto.tipoVenta?.toLowerCase() !== 'nuevo') && (MyRole === 'admin' || MyRole === 'lotero')"
                (click)="seleccionarTipo('lote')">
                <img src="assets/img/lote.png" alt="Lote" />
                <p>Lote</p>
                <ion-icon name="checkmark-circle-outline" class="icono-check"></ion-icon>
              </div>
            </div>

            <div class="contenedor_version"
              *ngIf="tipoSeleccionado === 'lote' && (MyRole == 'admin' || MyRole == 'lotero')">
              <ion-item>
                <ion-label position="stacked">Lote</ion-label>
                <ion-select [(ngModel)]="loteSeleccionado" placeholder="Selecciona un lote"
                  (ionChange)="seleccionarLote($event.detail.value)" interface="alert"
                  [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                  <ion-select-option *ngFor="let lote of lotes" [value]="lote._id">
                    {{ lote.nombre || 'Lote sin nombre' }}
                  </ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item *ngIf="ubicacionesLoteSeleccionado.length > 1">
                <ion-label position="stacked">Ubicaci√≥n</ion-label>
                <ion-select [(ngModel)]="direccionSeleccionada" placeholder="Selecciona una ubicaci√≥n"
                  (ionChange)="onUbicacionChange($event)" interface="alert"
                  [interfaceOptions]="{ cssClass: 'select-lote-rojo' }">
                  <ion-select-option *ngFor="let direccion of ubicacionesLoteSeleccionado; let i = index"
                    [value]="direccion">
                    {{ ubicacionesLoteLegibles[i] || 'Obteniendo direcci√≥n...' }}
                  </ion-select-option>
                </ion-select>
              </ion-item>

              <ion-item *ngIf="ubicacionesLoteSeleccionado.length === 1">
                <ion-input style="font-size: 10px;" readonly [value]="direccionCompleta"></ion-input>
              </ion-item>
            </div>

            <div class="bloque-ubicacion"
              *ngIf="tipoSeleccionado === 'particular' && (MyRole == 'admin' || MyRole == 'vendedor' || MyRole == 'lotero')">
              <button class="btn_ubicacion" type="button" (click)="seleccionarUbicacion()">
                <ion-icon name="location-outline" class="icono"></ion-icon>
                Seleccionar ubicaci√≥n
              </button>

              <div *ngIf="ubicacionSeleccionada" class="ubicacion-mostrada">
                <ion-icon name="location-outline"></ion-icon>
                {{ direccionCompleta }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- üî∏ SECCI√ìN IM√ÅGENES -->
    <div *ngIf="seccionActiva === 'imagenes'">
      <ion-grid>
        <ion-row>
          <ion-col size="12" size-md="6">
            <ion-card>
              <ion-card-header>
                <ion-card-title>Imagen principal del auto</ion-card-title>
                <ion-card-subtitle>Selecciona una imagen para remover el fondo</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <div class="botons">
                  <button class="button-nuevo" (click)="seleccionarImagen()">
                    <ion-icon name="add-outline"></ion-icon>
                    Nueva imagen
                  </button>
                  <input type="file" accept="image/*" hidden #inputArchivo (change)="cargarNuevaImagen($event)" />
                </div>

                <div class="contenedor-imagen">
                  <img [src]="imagenPrincipalMostrada" alt="Imagen principal del auto" />
                </div>
                <p class="texto_css">Selecciona una imagen para remover el fondo</p>

                <div class="galeria-scroll" *ngIf="urlsImagenes?.length">
                  <img *ngFor="let img of urlsImagenes" [src]="img" alt="Imagen del auto"
                    (click)="actualizarImagenPrincipal(img)" />
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>

          <ion-col size="12" size-md="6">
            <ion-card>
              <ion-card-header>
                <ion-card-title>Im√°genes de mi auto</ion-card-title>
                <ion-card-subtitle>Agrega m√°ximo 10 im√°genes</ion-card-subtitle>
              </ion-card-header>
              <ion-card-content>
                <label class="btn-agregar">
                  <ion-icon name="add-outline"></ion-icon>
                  Agregar imagen
                  <input type="file" accept="image/*" (change)="agregarImagen($event)" hidden />
                </label>

                <div class="galeria-scroll-big" *ngIf="urlsImagenes?.length">
                  <div class="img-wrapper" *ngFor="let img of urlsImagenes">
                    <img [src]="img" alt="Imagen del auto" />
                    <div class="overlay-botones">
                      <button class="btn-accion eliminar" (click)="eliminarImagen_visual(img)">
                        <ion-icon name="trash-outline"></ion-icon>
                        Eliminar
                      </button>
                    </div>
                  </div>
                </div>
              </ion-card-content>
            </ion-card>
          </ion-col>
        </ion-row>
      </ion-grid>
    </div>

    <!-- üî∏ BOTONES FINALES -->
    <div class="action-bar">
      <div class="action-buttons">
        <ion-button fill="clear" color="medium" (click)="regresar()">
          <ion-icon name="close-outline"></ion-icon>
          <span>Cancelar</span>
        </ion-button>

        <ion-button fill="outline" color="warning" (click)="onRestablecerClick()" [disabled]="!restablecer">
          <ion-icon name="refresh-outline"></ion-icon>
          <span>Restablecer</span>
        </ion-button>

        <ion-button fill="outline" color="danger" (click)="alert(auto?._id)" [disabled]="!auto?._id">
          <ion-icon name="trash-outline"></ion-icon>
          <span>Eliminar</span>
        </ion-button>

        <ion-button color="success" (click)="onGuardarClick()" [disabled]="!restablecer">
          <ion-icon name="save-outline"></ion-icon>
          <span>Guardar</span>
        </ion-button>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</ion-content>