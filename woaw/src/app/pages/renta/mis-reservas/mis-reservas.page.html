<app-navbar></app-navbar>

<ion-content [fullscreen]="true" class="mis-reservas">
  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <div class="page-head">
    <h1>Mis reservas</h1>
    <p class="sub">
      Historial y acciones rápidas. <span *ngIf="!loading">Total: {{ datos.length || 0 }}</span>
    </p>
    <div class="quick-chips">
      <ion-chip color="danger" outline="true">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <ion-label>Pendientes: {{ pendingOwner.length || 0 }}</ion-label>
      </ion-chip>
      <ion-chip color="success" outline="true" *ngIf="!loading && datos?.length">
        <ion-icon name="checkmark-circle-outline"></ion-icon>
        <ion-label>Registradas</ion-label>
      </ion-chip>
    </div>
  </div>

  <ion-list *ngIf="loading">
    <ion-item *ngFor="let i of [1,2,3,4]">
      <ion-skeleton-text animated style="width:100%; height:86px;"></ion-skeleton-text>
    </ion-item>
  </ion-list>

  <h2 class="section-title" *ngIf="loadingPending || pendingOwner.length > 0">Solicitudes de reserva</h2>
  <ion-card *ngIf="loadingPending || pendingOwner.length > 0" class="section-card">
    <ion-card-header>
      <ion-card-title>Solicitudes de reserva (tus coches)</ion-card-title>
      <ion-card-subtitle *ngIf="!loadingPending">
        {{ pendingOwner.length }} pendiente(s)
      </ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-list *ngIf="loadingPending">
        <ion-item *ngFor="let s of [1,2,3]">
          <ion-skeleton-text animated style="width:60%"></ion-skeleton-text>
        </ion-item>
      </ion-list>

      <ion-item *ngIf="!loadingPending && pendingOwner.length === 0" lines="none">
        <ion-icon name="checkmark-circle-outline" slot="start" color="success"></ion-icon>
        <ion-label>Sin solicitudes pendientes por ahora.</ion-label>
      </ion-item>

      <ion-list *ngIf="!loadingPending && pendingOwner.length > 0">
        <ion-item *ngFor="let b of pendingOwner" lines="full">
          <ion-label>
            <h3 class="truncate">
              {{ displayUsuario(b?.usuario) }}
              <ion-note color="medium"> • {{ b?.moneda || 'MXN' }} {{ b?.total | number:'1.0-0' }}</ion-note>
            </h3>
            <p>
              {{ b?.fechaInicio | date:'mediumDate' }} → {{ b?.fechaFin | date:'mediumDate' }}
              <ion-note color="medium"> ({{ b?.dias }} día(s))</ion-note>
            </p>
            <p *ngIf="b?.notasCliente" class="ion-text-wrap">
              <ion-icon name="chatbubble-ellipses-outline"></ion-icon>
              {{ b?.notasCliente }}
            </p>
          </ion-label>

          <div slot="end" class="actions">
            <ion-button size="small" color="success" (click)="acceptPending(b)" [disabled]="actingIds.has(b._id)">
              <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='accept'" name="crescent"></ion-spinner>
              <span *ngIf="!(actingIds.has(b._id) && actingAction==='accept')">Aceptar</span>
            </ion-button>

            <ion-button size="small" color="danger" fill="outline" (click)="cancelPending(b)"
              [disabled]="actingIds.has(b._id)">
              <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='cancel'" name="crescent"></ion-spinner>
              <span *ngIf="!(actingIds.has(b._id) && actingAction==='cancel')">Cancelar</span>
            </ion-button>
          </div>
        </ion-item>
      </ion-list>
    </ion-card-content>
  </ion-card>

  <div *ngIf="!loading && datos.length === 0" class="vacio">
    <ion-icon name="car-outline"></ion-icon>
    <p>No hay reservas registradas.</p>
  </div>

  <h2 class="section-title" *ngIf="!loading && datos.length">Tus reservas</h2>
  <ion-list *ngIf="!loading && datos.length">
    <ion-card class="booking-card" *ngFor="let b of datos; trackBy: trackByBooking" [attr.data-status]="b.estatus">
      <ion-card-header>
        <div class="header-line">
          <ion-card-title class="truncate">Reserva #{{ b.codigo || b._id }}</ion-card-title>
          <ion-badge [color]="colorEstatus(b.estatus)">{{ b.estatus }}</ion-badge>
        </div>
        <ion-card-subtitle class="dates">
          <ion-icon name="calendar-outline"></ion-icon>
          {{ b.fechaInicio | date:'medium' }} → {{ b.fechaFin | date:'medium' }}
        </ion-card-subtitle>
      </ion-card-header>

      <ion-card-content>
        <div class="meta-grid">
          <div class="cell">
            <small>Moneda</small>
            <div class="row"><ion-icon name="card-outline"></ion-icon><span>{{ b.moneda || 'MXN' }}</span></div>
          </div>
          <div class="cell">
            <small>Total</small>
            <div class="row strong"><ion-icon name="cash-outline"></ion-icon>
              <span>{{ b.total | currency:(b.moneda || 'MXN'):'symbol-narrow' }}</span>
            </div>
          </div>
        </div>

        <div class="acciones">
          <ion-button *ngIf="puedeIniciar(b)" color="warning" (click)="iniciarRenta(b)"
            [disabled]="actingIds.has(b._id)">
            <ion-spinner *ngIf="actingIds.has(b._id) && actingAction==='start'" name="crescent"></ion-spinner>
            <span *ngIf="!(actingIds.has(b._id) && actingAction==='start')">Iniciar renta</span>
          </ion-button>
          <ion-note color="danger"
            *ngIf="soyPropietarioDeAuto(b) && b.estatus==='aceptada' && esHoy(b.fechaInicio) && !tieneCheckIn(b)">
            Falta realizar el Check-In para iniciar.
          </ion-note>

          <ion-button *ngIf="puedeFinalizar(b)" color="success" (click)="irCheckout(b)">
            Finalizar renta
          </ion-button>

          <ion-button color="danger" fill="solid" (click)="irAccion(b)">
            <ng-container *ngIf="soyPropietarioDeAuto(b); else noOwner">
              <ng-container *ngIf="b.estatus === 'aceptada'">Ir a Check-In</ng-container>
              <ng-container *ngIf="b.estatus === 'en_curso'">Ver Check-In</ng-container>
              <ng-container *ngIf="b.estatus === 'finalizada'">Ir a Check-Out</ng-container>
              <ng-container *ngIf="b.estatus !== 'aceptada' && b.estatus !== 'en_curso' && b.estatus !== 'finalizada'">
                Ver detalle
              </ng-container>
            </ng-container>
            <ng-template #noOwner>
              <ng-container *ngIf="esSolicitante(b); else soloDetalle">
                <ng-container *ngIf="b.estatus === 'finalizada'">Ver Check-Out</ng-container>
                <ng-container *ngIf="b.estatus !== 'finalizada'">Ver Check-In</ng-container>
              </ng-container>
              <ng-template #soloDetalle>Ver detalle</ng-template>
            </ng-template>
          </ion-button>

          <ion-button color="medium" fill="outline" (click)="openDetalle(b)">Detalle</ion-button>
        </div>
      </ion-card-content>
    </ion-card>
  </ion-list>

  <h2 class="section-title" *ngIf="hasMore && !loading">Más resultados</h2>
  <ion-infinite-scroll *ngIf="hasMore" threshold="100px" (ionInfinite)="cargarMas($event)">
    <ion-infinite-scroll-content loadingSpinner="bubbles" loadingText="Cargando más..."></ion-infinite-scroll-content>
  </ion-infinite-scroll>
  <app-footer></app-footer>
</ion-content>