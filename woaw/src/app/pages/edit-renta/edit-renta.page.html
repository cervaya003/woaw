<ion-header>
  <ion-toolbar color="dark">
    <ion-buttons slot="start">
      <div class="perfil-header">
        <button class="btn-regresar" (click)="regresar()">
          <ion-icon name="arrow-back-outline"></ion-icon>
        </button>
        <img src="/assets/icon/logo4.png" alt="Go Autos" class="logo" />
        <span *ngIf="renta" class="titulo-perfil">
          {{ renta?.marca }} {{ renta?.modelo }}
        </span>
      </div>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button (click)="regresar()">
        <ion-icon name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="contenedor">

    <!-- Datos del vehículo (alineados a registrar) -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Tipo de vehículo</ion-label>
            <ion-select [(ngModel)]="renta.tipoVehiculo" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione…</ion-select-option>
              <ion-select-option value="sedan">sedan</ion-select-option>
              <ion-select-option value="suv">suv</ion-select-option>
              <ion-select-option value="pickup">pickup</ion-select-option>
              <ion-select-option value="van">van</ion-select-option>
              <ion-select-option value="hatchback">hatchback</ion-select-option>
              <ion-select-option value="otro">otro</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Transmisión</ion-label>
            <ion-select [(ngModel)]="renta.transmision" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione…</ion-select-option>
              <ion-select-option value="manual">manual</ion-select-option>
              <ion-select-option value="automática">automática</ion-select-option>
              <ion-select-option value="CVT">CVT</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Combustible</ion-label>
            <ion-select [(ngModel)]="renta.combustible" (ionChange)="markDirty()">
              <ion-select-option value="">Seleccione…</ion-select-option>
              <ion-select-option value="gasolina">gasolina</ion-select-option>
              <ion-select-option value="diesel">diesel</ion-select-option>
              <ion-select-option value="híbrido">híbrido</ion-select-option>
              <ion-select-option value="eléctrico">eléctrico</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="3">
          <ion-item>
            <ion-label position="stacked">Pasajeros</ion-label>
            <ion-input type="number" min="1" [(ngModel)]="renta.pasajeros" (ionInput)="markDirty()" placeholder="Ej. 5">
            </ion-input>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Precio y moneda (moneda es UI, no se envía) -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Precio por día <span class="req">*</span></ion-label>
            <ion-input type="number" min="500" [(ngModel)]="renta.precioPorDia" (ionInput)="markDirty()"></ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Moneda</ion-label>
            <ion-select [(ngModel)]="renta.moneda" (ionChange)="markDirty()">
              <ion-select-option value="MXN">MXN</ion-select-option>
              <ion-select-option value="USD">USD</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Políticas y requisitos -->
    <ion-grid>
      <ion-row>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Política combustible</ion-label>
            <ion-select [(ngModel)]="renta.politicaCombustible" (ionChange)="markDirty()">
              <ion-select-option value="lleno-lleno">lleno-lleno</ion-select-option>
              <ion-select-option value="como-esta">como-esta</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Política limpieza</ion-label>
            <ion-select [(ngModel)]="renta.politicaLimpieza" (ionChange)="markDirty()">
              <ion-select-option value="normal">normal</ion-select-option>
              <ion-select-option value="estricta">estricta</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Edad mínima</ion-label>
            <ion-input type="number" min="18" [(ngModel)]="renta.requisitosConductor.edadMinima"
              (ionInput)="markDirty()"></ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Antigüedad licencia (meses)</ion-label>
            <ion-input type="number" min="0" [(ngModel)]="renta.requisitosConductor.antiguedadLicenciaMeses"
              (ionInput)="markDirty()"></ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Conductor adicional</ion-label>
            <ion-select [(ngModel)]="renta.requisitosConductor.permiteConductorAdicional" (ionChange)="markDirty()">
              <ion-select-option [value]="false">No</ion-select-option>
              <ion-select-option [value]="true">Sí</ion-select-option>
            </ion-select>
          </ion-item>
        </ion-col>

        <ion-col size="12" size-md="6" *ngIf="renta.requisitosConductor.permiteConductorAdicional">
          <ion-item>
            <ion-label position="stacked">Costo conductor adicional</ion-label>
            <ion-input type="number" min="0" [(ngModel)]="renta.requisitosConductor.costoConductorAdicional"
              (ionInput)="markDirty()"></ion-input>
          </ion-item>
        </ion-col>

      </ion-row>
    </ion-grid>

    <!-- Entrega y tarifas -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-item>
            <ion-label position="stacked">Entrega gratis hasta (km)</ion-label>
            <ion-input type="number" min="0" [(ngModel)]="renta.entrega.gratuitoHastaKm"
              (ionInput)="onGratisHastaChange()"></ion-input>
          </ion-item>
        </ion-col>

        <ion-col size="12">
          <div class="tarifas">
            <div class="tarifas__header">
              <label class="tarifas__title">Tarifas por distancia</label>
              <button type="button" class="btn btn-soft btn-sm" (click)="addTarifa()">+ Agregar tarifa</button>
            </div>
            <p class="hint">Agrega al menos una tarifa o especifica “Entrega gratis hasta (km)”.</p>

            <div class="tarifa-card" *ngFor="let t of renta.entrega.tarifasPorDistancia; let i = index">
              <div class="tarifa-card__top">
                <h5 class="tarifa-card__title">Tarifa {{ i + 1 }}</h5>
                <button type="button" class="btn btn-danger btn-sm" (click)="removeTarifa(i)">
                  <ion-icon name="trash-outline"></ion-icon> Quitar
                </button>
              </div>

              <div class="tarifa-card__grid">
                <div class="campo">
                  <label>Desde (km)</label>
                  <input type="number" min="0" [(ngModel)]="t.desdeKm"
                    [readonly]="i === 0 ? (+renta.entrega.gratuitoHastaKm) > 0 : true" placeholder="0" />
                  <small class="hint" *ngIf="i === 0 && (+renta.entrega.gratuitoHastaKm) > 0">
                    Fijado a {{ renta.entrega.gratuitoHastaKm }} km (igual a “Entrega gratis hasta”).
                  </small>
                  <small class="hint" *ngIf="i > 0">
                    Fijado a {{ renta.entrega.tarifasPorDistancia[i-1].hastaKm || 0 }} km (fin del rango anterior).
                  </small>
                </div>

                <div class="campo">
                  <label>Hasta (km)</label>
                  <input type="number" min="0" [(ngModel)]="t.hastaKm" (ngModelChange)="onTarifaHastaChange(i)" />
                </div>

                <div class="campo">
                  <label>Costo fijo</label>
                  <input type="number" min="0" step="0.01" [(ngModel)]="t.costoFijo" />
                </div>

                <div class="campo full">
                  <label>Nota (opcional)</label>
                  <input type="text" [(ngModel)]="t.nota" placeholder="Ej. Zona centro" />
                </div>
              </div>
            </div>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Ubicación -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <button class="btn_ubicacion" type="button" (click)="seleccionarUbicacion()">
            <ion-icon name="location-outline" class="icono"></ion-icon>
            Seleccionar ubicación
          </button>

          <div *ngIf="direccionCompleta" class="ubicacion-mostrada">
            <ion-icon name="location-outline"></ion-icon>
            {{ direccionCompleta }}
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Imágenes -->
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Imagen principal</ion-card-title>
              <ion-card-subtitle>Selecciona una imagen para el listado</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <div class="botons">
                <button class="button-nuevo" (click)="seleccionarImagen()">
                  <ion-icon name="add-outline"></ion-icon>
                  Nueva imagen
                </button>
                <input type="file" accept="image/*" hidden #inputArchivo (change)="cargarNuevaImagen($event)" />
              </div>

              <div class="contenedor-imagen">
                <img [src]="imagenPrincipalMostrada || '/assets/default-car.webp'" alt="Imagen principal" />
              </div>

              <div class="galeria-scroll" *ngIf="urlsImagenes?.length">
                <img *ngFor="let img of urlsImagenes" [src]="img" alt="Imagen"
                  (click)="actualizarImagenPrincipal(img)" />
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>

        <ion-col size="12" size-md="6">
          <ion-card>
            <ion-card-header>
              <ion-card-title>Imágenes de mi auto</ion-card-title>
              <ion-card-subtitle>Agrega máximo 10 imágenes</ion-card-subtitle>
            </ion-card-header>
            <ion-card-content>
              <label class="btn-agregar">
                <ion-icon name="add-outline"></ion-icon>
                Agregar imagen
                <input type="file" accept="image/*" (change)="agregarImagen($event)" hidden />
              </label>

              <div class="galeria-scroll-big" *ngIf="urlsImagenes?.length">
                <div class="img-wrapper" *ngFor="let img of urlsImagenes">
                  <img [src]="img" alt="Imagen" />
                  <div class="overlay-botones">
                    <button class="btn-accion eliminar" (click)="eliminarImagen_visual(img)">
                      <ion-icon name="trash-outline"></ion-icon>
                      Eliminar
                    </button>
                  </div>
                </div>
              </div>

            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>

    <!-- Barra de acciones -->
    <div class="action-bar">
      <div class="action-buttons">
        <ion-button fill="clear" color="medium" (click)="regresar()">
          <ion-icon name="close-outline"></ion-icon>
          <span>Cancelar</span>
        </ion-button>

        <ion-button fill="outline" color="warning" (click)="onRestablecerClick()" [disabled]="!dirty">
          <ion-icon name="refresh-outline"></ion-icon>
          <span>Restablecer</span>
        </ion-button>

        <ion-button color="success" (click)="onGuardarClick()" [disabled]="!dirty">
          <ion-icon name="save-outline"></ion-icon>
          <span>Guardar</span>
        </ion-button>
      </div>
    </div>
  </div>

  <app-footer></app-footer>
</ion-content>