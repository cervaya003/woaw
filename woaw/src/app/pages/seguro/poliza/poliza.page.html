<app-navbar></app-navbar>

<ion-content [fullscreen]="true">
  <app-spinner *ngIf="mostrar_spinnet"></app-spinner>
  
  <div class="fondo-seguros">
    <!-- <img src="/assets/autos/seg.png" alt=""> -->
    <span class="fondo-seguros__overlay"></span>
  </div>

  <div class="split-woaw-seguros" style="--left: 80%; --right: 20%; --gap: 1px;">

    <div class="divicion1">
      <div class="poliza">
        <section class="poliza__card">

          <ng-container *ngIf="!polizaCreada">
            <h1>Crear poliza</h1>
            <form [formGroup]="form_poliza" (ngSubmit)="siguiente()">

              <div class="field field-grid">
                <div>
                  <label for="vin">VIN del auto</label>
                  <div class="control">
                    <input id="vin" type="text" class="form-input" placeholder="XX17XFSF" formControlName="vin"
                      maxlength="17" (input)="onVinInput($event)" />
                  </div>
                  <p *ngIf="analizaForm('vin')" class="error">El VIN es obligatorio</p>
                </div>
                <div>
                  <label for="placas">Placas del auto</label>
                  <div class="control">
                    <input id="placas" type="text" class="form-input" placeholder="UQTWRBS" formControlName="placas"
                      maxlength="7" (input)="onPlacasInput($event)" />
                  </div>
                  <p *ngIf="analizaForm('placas')" class="error">Las placas son obligatorias</p>
                </div>

                <div>
                  <label for="color">Color del auto</label>
                  <div class="control">
                    <select id="color" class="form-input" formControlName="color">
                      <option value="" disabled selected>Selecciona un color</option>
                      <option *ngFor="let opt of colorOpts" [value]="opt.value">
                        {{ opt.label }}
                      </option>
                    </select>
                  </div>
                  <p *ngIf="analizaForm('color')" class="error">
                    El color es obligatorio
                  </p>
                </div>

                <div>
                  <label for="color">Seleciona tu plan</label>
                  <div class="control">
                    <ion-select interface="popover" formControlName="pago" placeholder="Elige un plan de pago..." aria-label="Plan de pago"
                      class="pay-select" [(ngModel)]="selectedPaymentId"
                      (ionChange)="onSelectPayment($event.detail.value)">

                      <ion-select-option *ngFor="let opt of datoscotizacion?.plans?.[0]?.payment_plans"
                        [value]="opt.id">
                        {{ paymentPlanLabel(opt) }} ‚Äî {{ fmtMoney(opt.total) }}
                      </ion-select-option>

                    </ion-select>
                  </div>
                </div>

              </div>

              <!-- Correos din√°micos -->
              <div class="field">
                <label>Correos de contacto (opcional)</label>

                <div formArrayName="correos" class="correos-wrap">
                  <div class="correo-item" *ngFor="let ctrl of correos.controls; let i = index;">

                    <div class="control">
                      <input class="form-input" type="email" [formControlName]="i" placeholder="correo@ejemplo.com"
                        inputmode="email" autocomplete="email" (input)="normalizeCorreo(i)" />
                    </div>

                    <button type="button" class="btn-ghost danger" (click)="removeCorreo(i)"
                      aria-label="Eliminar correo">
                      Eliminar
                    </button>

                    <p *ngIf="ctrl.invalid && (ctrl.dirty || ctrl.touched)" class="error">
                      {{ getCorreoError(ctrl.errors) }}
                    </p>
                  </div>
                </div>

                <div class="correos-actions">
                  <button type="button" class="btn-outline" (click)="addCorreo()" [disabled]="!canAddCorreo">
                    Agregar correo
                    <small *ngIf="correos.length>0">({{correos.length}}/2)</small>
                  </button>
                </div>

                <p *ngIf="correos.hasError('duplicated') && (correos.dirty || correos.touched)" class="error">
                  No repitas el mismo correo.
                </p>

              </div>


              <div class="paybox__cta">
                <button type="button" class="btn-secondary" (click)="regresarPage()">
                  &#x2B05; Regresar
                </button>
                <button type="submit" class="btn-primary">
                  Siguiente &#x27A1;
                </button>
              </div>

            </form>
          </ng-container>

          <ng-container *ngIf="polizaCreada && datosPolizaCreada as d">
            <section class="poliza_creada">

              <div class="poliza__hero">

                <div class="poliza__msg">

                  <ion-icon name="checkmark-circle"></ion-icon>
                  <h2>P√≥liza creada correctamente</h2>

                  <p>
                    Hemos enviado la informaci√≥n de tu p√≥liza a tu correo electr√≥nico <strong>{{ this.email
                      }}üìß.</strong>
                    <br><br>
                    Revisa tu bandeja de entrada para descargar tus documentos digitales.
                  </p>
                </div>

                <button class="bt_paga" (click)="realizarPago()">
                  <ion-icon name="cash-outline"></ion-icon>
                  Realizar pago
                </button>
                <button class="bt_regresar_r" (click)="regresar()">
                  &#x2B05;
                  Realizar nueva cotizac√≥n
                </button>
              </div>

            </section>
          </ng-container>

        </section>
      </div>
      <!-- <app-dynamic-island [refreshKey]="islandKey"></app-dynamic-island> -->
    </div>

    <div class="divicion2">
      <app-otros-seguros [refreshKey]="islandKey"></app-otros-seguros>
    </div>
  </div>

  <app-footer></app-footer>
</ion-content>